<?php
if (!defined('ABSPATH')) {
    exit;
}

$vswaf_options = get_option('upshield_options', []);
$vswaf_enabled = $vswaf_options['malware_scanner_enabled'] ?? true;
$vswaf_schedule = $vswaf_options['malware_scan_schedule'] ?? 'weekly';
$vswaf_scope = $vswaf_options['malware_scan_scope'] ?? 'all';
// $vswaf_latest_scan is passed from controller
?>
<div class="wrap upshield-wrap" id="upshield-malware-scanner">
    <div class="upshield-header">
        <div class="upshield-logo">
            <span class="dashicons dashicons-shield-alt"></span>
            <h1><?php esc_html_e('Malware Scanner', 'upshield-waf'); ?> <span style="font-size: 13px; color: #666; font-weight: 400; margin-left: 8px;">v<?php echo esc_html(UPSHIELD_VERSION); ?></span></h1>
        </div>
        <div class="upshield-status">
            <?php if ($vswaf_enabled): ?>
                <span class="status-badge status-active">
                    <span class="dashicons dashicons-yes-alt"></span>
                    <?php esc_html_e('Scanner Enabled', 'upshield-waf'); ?>
                </span>
            <?php else: ?>
                <span class="status-badge status-inactive">
                    <span class="dashicons dashicons-dismiss"></span>
                    <?php esc_html_e('Scanner Disabled', 'upshield-waf'); ?>
                </span>
            <?php endif; ?>
        </div>
    </div>

    <div class="upshield-card">
        <div class="card-header">
            <h2>
                <span class="dashicons dashicons-search"></span>
                <?php esc_html_e('Malware Scan', 'upshield-waf'); ?>
            </h2>
            <div class="header-actions">
                <select id="malware-scan-scope">
                    <option value="all" <?php selected($vswaf_scope, 'all'); ?>><?php esc_html_e('All (Themes + Plugins + Uploads)', 'upshield-waf'); ?></option>
                    <option value="themes" <?php selected($vswaf_scope, 'themes'); ?>><?php esc_html_e('Themes Only', 'upshield-waf'); ?></option>
                    <option value="plugins" <?php selected($vswaf_scope, 'plugins'); ?>><?php esc_html_e('Plugins Only', 'upshield-waf'); ?></option>
                    <option value="uploads" <?php selected($vswaf_scope, 'uploads'); ?>><?php esc_html_e('Uploads Only', 'upshield-waf'); ?></option>
                </select>
                <button id="upshield-run-malware-scan" class="button button-primary" <?php disabled(!$vswaf_enabled); ?>>
                    <span class="dashicons dashicons-search"></span>
                    <?php esc_html_e('Run Scan', 'upshield-waf'); ?>
                </button>
                <button id="upshield-clear-malware-history" class="button button-secondary">
                    <span class="dashicons dashicons-trash"></span>
                    <?php esc_html_e('Clear History', 'upshield-waf'); ?>
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="description">
                <?php esc_html_e('This scan checks themes, plugins, and uploads for malicious code patterns, backdoors, and suspicious files using signature-based and heuristic detection.', 'upshield-waf'); ?>
            </p>
            <div class="scan-meta">
                <div><strong><?php esc_html_e('Schedule:', 'upshield-waf'); ?></strong> <?php echo esc_html(ucfirst($vswaf_schedule)); ?></div>
                <div><strong><?php esc_html_e('Last Scan:', 'upshield-waf'); ?></strong>
                    <?php
                    if (is_array($vswaf_latest_scan) && !empty($vswaf_latest_scan['finished_at'])) {
                        require_once UPSHIELD_PLUGIN_DIR . 'includes/class-upshield-helpers.php';
                        echo esc_html(\UpShield_Helpers::format_timestamp($vswaf_latest_scan['finished_at'], 'Y-m-d H:i:s'));
                        if (!empty($vswaf_latest_scan['id'])) {
                            echo ' <span class="scan-id-badge">(Scan #' . esc_html($vswaf_latest_scan['id']) . ')</span>';
                        }
                    } else {
                        esc_html_e('Never', 'upshield-waf');
                    }
                    ?>
                </div>
                <?php if (!empty($vswaf_latest_scan['scope'])): ?>
                <div><strong><?php esc_html_e('Last Scope:', 'upshield-waf'); ?></strong> <?php echo esc_html(ucfirst($vswaf_latest_scan['scope'])); ?></div>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <div class="upshield-stats-grid" id="upshield-malware-stats">
        <div class="stat-card stat-total">
            <div class="stat-icon">
                <span class="dashicons dashicons-media-code"></span>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="malware-total-files">0</div>
                <div class="stat-label"><?php esc_html_e('Files Scanned', 'upshield-waf'); ?></div>
            </div>
        </div>
        <div class="stat-card stat-success">
            <div class="stat-icon">
                <span class="dashicons dashicons-yes-alt"></span>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="malware-clean-files">0</div>
                <div class="stat-label"><?php esc_html_e('Clean Files', 'upshield-waf'); ?></div>
            </div>
        </div>
        <div class="stat-card stat-blocked">
            <div class="stat-icon">
                <span class="dashicons dashicons-warning"></span>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="malware-infected-files">0</div>
                <div class="stat-label"><?php esc_html_e('Infected Files', 'upshield-waf'); ?></div>
            </div>
        </div>
        <div class="stat-card stat-sqli">
            <div class="stat-icon">
                <span class="dashicons dashicons-visibility"></span>
            </div>
            <div class="stat-content">
                <div class="stat-value" id="malware-suspicious-files">0</div>
                <div class="stat-label"><?php esc_html_e('Suspicious Files', 'upshield-waf'); ?></div>
            </div>
        </div>
    </div>

    <div class="upshield-card">
        <div class="card-header">
            <h2>
                <span class="dashicons dashicons-list-view"></span>
                <?php esc_html_e('Scan Results', 'upshield-waf'); ?>
            </h2>
            <div class="header-actions">
                <select id="malware-severity-filter">
                    <option value=""><?php esc_html_e('All Severities', 'upshield-waf'); ?></option>
                    <option value="critical"><?php esc_html_e('Critical', 'upshield-waf'); ?></option>
                    <option value="high"><?php esc_html_e('High', 'upshield-waf'); ?></option>
                    <option value="medium"><?php esc_html_e('Medium', 'upshield-waf'); ?></option>
                    <option value="low"><?php esc_html_e('Low', 'upshield-waf'); ?></option>
                </select>
            </div>
        </div>
        <div class="card-body">
            <table class="upshield-table" id="malware-results-table">
                <thead>
                    <tr>
                        <th><?php esc_html_e('Severity', 'upshield-waf'); ?></th>
                        <th><?php esc_html_e('File Path', 'upshield-waf'); ?></th>
                        <th><?php esc_html_e('Type', 'upshield-waf'); ?></th>
                        <th><?php esc_html_e('Findings', 'upshield-waf'); ?></th>
                        <th><?php esc_html_e('Size', 'upshield-waf'); ?></th>
                        <th><?php esc_html_e('Modified', 'upshield-waf'); ?></th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="empty-row">
                        <td colspan="6"><?php esc_html_e('No scan results yet. Run a scan to detect malware.', 'upshield-waf'); ?></td>
                    </tr>
                </tbody>
            </table>
            <div class="malware-pagination" id="malware-pagination"></div>
        </div>
    </div>
</div>

<!-- Finding Details Modal -->
<div id="malware-finding-modal" class="upshield-modal" style="display:none;">
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3><span class="dashicons dashicons-warning"></span> <?php esc_html_e('Finding Details', 'upshield-waf'); ?></h3>
            <button class="modal-close" type="button">&times;</button>
        </div>
        <div class="modal-body" id="malware-finding-details">
            <!-- Populated by JS -->
        </div>
        <div class="modal-footer">
            <button class="button button-secondary modal-close-btn" type="button"><?php esc_html_e('Close', 'upshield-waf'); ?></button>
        </div>
    </div>
    
    <?php include UPSHIELD_PLUGIN_DIR . 'admin/views/partials/footer.php'; ?>
</div>
